---
- name: Scan and register SSH host keys (hostname)
  command: "ssh-keyscan {{ hostvars[item]['ansible_host'] }}"
  register: "host_keys_hostname"
  changed_when: false
  with_items: "{{ groups['all'] }}"
  delegate_to: localhost
  become: false

- name: Scan and register SSH host keys
  command: "ssh-keyscan {{ hostvars[item]['ansible_default_ipv4']['address'] }}"
  register: "host_keys_ip"
  changed_when: false
  with_items: "{{ groups['all'] }}"
  delegate_to: localhost
  become: false

- name: Write SSH host keys
  template:
    src: "ssh_hosts.j2"
    dest: "/etc/ssh/known_hosts"
  become: true

- name: Capturing SSH keys
  command: "cat /home/vagrant/.ssh/id_rsa.pub"
  register: "_ssh_pub_key"
  become: true
  changed_when: false

- name: Generating SSH keys
  template:
   src: "ssh_keys_distribution.yml.j2"
   dest: "ssh_keys_distribution.yml"
  become: false
  run_once: true
  delegate_to: localhost

- name: Adding SSH keys
  authorized_key:
    user: "{{ item[1]['user'] }}"
    key: "{{ item[1]['key'] }}"
    state: "present"
  become: true
  with_subelements:
    - "{{ _ssh_keys_distribution }}"
    - keys
  when: inventory_hostname != item[0]['host']
